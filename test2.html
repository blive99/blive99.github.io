<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FUCKIDPLUS3.0</title>

  <!-- hls.js for HLS, dash.js for DASH -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#ff7f00; --muted:#98a1b3; --glass: rgba(255,255,255,0.03);
    }
    html,body{height:100%;margin:0;font-family:Inter, Roboto, Arial;background:linear-gradient(180deg,#071021 0%, #071727 100%);color:#e6eef8}
    header{padding:14px 20px;text-align:center}
    header h1{margin:0;color:var(--accent);font-size:28px;letter-spacing:1px}
    .app{display:grid;grid-template-columns:300px 1fr;gap:16px;padding:12px;height:calc(100vh - 70px)}
    aside{background:var(--card);border-radius:12px;padding:12px;overflow:auto}
    .groups{display:flex;flex-direction:column;gap:6px}
    .group-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;text-align:left;color:var(--muted);cursor:pointer}
    .group-btn.active{background:linear-gradient(90deg, rgba(255,127,0,0.12), rgba(255,127,0,0.04));color:#fff;border-color:rgba(255,127,0,0.18)}
    .channels{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .channel-card{background:var(--glass);border-radius:8px;padding:6px;display:flex;gap:8px;align-items:center;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .channel-card img{width:48px;height:32px;object-fit:cover;border-radius:4px}
    .channel-card .meta{font-size:13px}
    .player-area{background:var(--card);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;overflow:auto}
    .video-wrap{background:#000;border-radius:8px;padding:6px;display:flex;align-items:center;justify-content:center;min-height:320px}
    video{width:100%;height:480px;max-height:65vh;background:#000;border-radius:6px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#fff;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    form{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff}
    label{font-size:13px;color:var(--muted)}
    .bottom-area{margin-top:8px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px}
    .row .flex{flex:1}
    .hidden{display:none}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:12px}
    @media(max-width:900px){.app{grid-template-columns:1fr;grid-auto-rows:auto}.video-wrap video{height:260px}}
  </style>
</head>
<body>
  <header><h1>FUCKIDPLUS3.0</h1></header>

  <div class="app">
    <aside>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong class="small">‡∏Å‡∏•‡∏∏‡πà‡∏° / ‡∏´‡∏°‡∏ß‡∏î</strong>
          <div style="display:flex;gap:6px">
            <button id="importBtn" class="btn secondary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ M3U</button>
            <button id="exportBtn" class="btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å M3U</button>
          </div>
        </div>

        <div class="groups" id="groupsList"></div>

        <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">

        <div>
          <strong class="small">‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong>
          <div class="channels" id="channelsList"></div>
        </div>

        <div style="margin-top:12px">
          <strong class="small">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</strong>
          <input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á..." />
        </div>

      </div>
    </aside>

    <main class="player-area">
      <div class="video-wrap">
        <video id="video" controls crossorigin playsinline></video>
      </div>

      <div class="controls">
        <div id="nowPlaying" class="small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á</div>
        <div style="flex:1"></div>
        <button id="reloadPlayer" class="btn secondary">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î player</button>
      </div>

      <div class="bottom-area">
        <strong class="small">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</strong>
        <form id="addForm" onsubmit="return false;">
          <div class="row">
            <div class="flex">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á</label>
              <input id="chName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô MONOMAX1" />
            </div>
            <div style="width:140px">
              <label>‡∏Å‡∏•‡∏∏‡πà‡∏°</label>
              <input id="chGroup" placeholder="‡πÄ‡∏ä‡πà‡∏ô üì∫ VIP SPORT" />
            </div>
          </div>

          <label>URL (m3u8 / mp4 / ts / mpd)</label>
          <input id="chUrl" required placeholder="https://..." />

          <div class="row">
            <div class="flex">
              <label>‡πÇ‡∏•‡πÇ‡∏Å‡πâ (URL)</label>
              <input id="chLogo" placeholder="https://... (‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 320x180)" />
            </div>
            <div style="width:180px">
              <label>‡∏ä‡∏ô‡∏¥‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÄ‡∏î‡∏≤)</label>
              <select id="chType">
                <option value="">Auto</option>
                <option value="hls">HLS (.m3u8)</option>
                <option value="dash">DASH (.mpd)</option>
                <option value="progressive">MP4/TS</option>
              </select>
            </div>
          </div>

          <div style="margin-top:6px">
            <label>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå MPD: KID ‡πÅ‡∏•‡∏∞ Key (ClearKey) ‚Äî ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö kid:key (base64 ‡∏´‡∏£‡∏∑‡∏≠ hex)</label>
            <div class="row">
              <input id="mpdKid" placeholder="kid (‡πÄ‡∏ä‡πà‡∏ô base64kid ‡∏´‡∏£‡∏∑‡∏≠ hex)" />
              <input id="mpdKey" placeholder="key (‡πÄ‡∏ä‡πà‡∏ô base64key ‡∏´‡∏£‡∏∑‡∏≠ hex)" />
            </div>
            <div class="small" style="margin-top:4px;color:var(--muted)">
              ‡∏´‡∏≤‡∏Å‡πÉ‡∏™‡πà KID ‡πÅ‡∏•‡∏∞ Key ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ClearKey ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dash.js ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô mpd + clearkey-compatible).
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addBtn" class="btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á</button>
            <button id="clearForm" class="btn secondary">‡∏•‡πâ‡∏≤‡∏á</button>
          </div>
        </form>

        <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)">
        <div>
          <strong class="small">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå M3U</strong>
          <input id="m3uFile" type="file" accept=".m3u,.m3u8,text/plain" />
          <div class="small" style="margin-top:6px;color:var(--muted)">
            ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå M3U ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
          </div>
        </div>

      </div>
    </main>
  </div>

  <footer>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ FUCKIDPLUS3.0 ‚Äî ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HLS / DASH (mpd with ClearKey) / MP4 / TS</footer>

<script>
/* ======= Data model ======= */
let channels = []; // {name, url, logo, group, type, mpdKid, mpdKey}
let groups = new Set();

/* ======= Sample default playlist (‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ) ======= */
const defaultM3U = `###SPORT###
#EXTINF:-1 tvg-id="" tvg-logo="https://www.img03.xyz/assets/img/ch_logo/Monomax_Sport01.png" group-title="üì∫ VIP SPORT",MONOMAX1
#EXTVLCOPT:http-user-agent=Mozilla/5.0 (Linux; Android 7.1.2; TV BOX Build/NHG47L) AppleWebKit/537.36 (KHTML ‡πÄ‡∏ä‡πà‡∏ô Gecko) Chrome/56.0.2924.87 Safari/537.36
#EXTVLCOPT:http-referrer=https://bestcommt2.github.io
http://bestcommt2.github.io/m3u8/monomax1.m3u8
#EXTINF:-1 group-title="üì∫ VIP SPORT" tvg-logo="https://www.jsports.co.jp/img/icon/ch1.png", J SPORTS 1
https://mt01.utako.moe/js1/index.m3u8
###PREMIUM PLAY TV###
#EXTINF:-1 group-title="üì∫ PREMIUM PLAY TV" tvg-logo="https://i.ibb.co/B53tBWkh/logoizaamovie.png",IZAAMOVIE
http://49.0.64.96:8007/IZAA
###BallThai###
#EXTINF:-1 tvg-name="PlaysportsFootball2" tvg-logo="https://www.img10.xyz/assets/img/ch_logo/AISplay-sport2.jpg" group-title="üì∫ ‡πÑ‡∏ó‡∏¢‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏£‡πå",PLAY SPORTS FOOTBALL 2
#EXTVLCOPT:http-referrer=https://olympic-embed.ais-vidnt.com
#EXTVLCOPT:http-user-agent=Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1
https://49-231-34-108-rewriter.ais-vidnt.com/ais/play/anevia/live/eds/TL002/HLS/TL002.m3u8 
###‡∏ó‡∏µ‡∏ß‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•‡πÑ‡∏ó‡∏¢###
#EXTINF:-1 tvg-id="TSports7.th" tvg-name="T Sports 7" tvg-logo="https://58-64-52-73-rewriter.ais-vidnt.com/ais/play/origin/LIVE/channelicon/T-SPorts_7_Final.png" group-title="üì∫ ‡∏ó‡∏µ‡∏ß‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ï‡∏≠‡∏•",T Sports 7
#KODIPROP:inputstreamaddon=inputstream.adaptive
#KODIPROP:inputstream.adaptive.manifest_type=dash
#KODIPROP:inputstream.adaptive.license_type=clearkey
#KODIPROP:inputstream.adaptive.license_key=6187523f92b9475bb5b192f70cef1342:5119311f482144d58dacabc5bc1fa4ba
https://udn-streamer1.cdn.3bbtv.com:8443/3bb/live/7/7.mpd
`;

/* ======= Utilities: parse M3U (basic, flexible) ======= */
function parseM3U(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim());
  let result = [];
  let lastExt = null;
  for(let i=0;i<lines.length;i++){
    const l = lines[i];
    if(!l) continue;
    if(l.startsWith('#EXTINF')){
      lastExt = l;
      continue;
    }
    if(l.startsWith('#') && l.toUpperCase().startsWith('#KODIPROP')){
      // append to lastExt as extra metadata
      if(lastExt) lastExt += '\n' + l;
      continue;
    }
    if(l.startsWith('#')) continue;
    // this is a URL line
    if(lastExt){
      const meta = parseExtInf(lastExt);
      const url = l;
      result.push({...meta, url});
      lastExt = null;
    } else {
      // line without EXTINF: treat as a simple url entry
      result.push({name: l, url: l, logo:'', group:''});
    }
  }
  return result;
}

function parseExtInf(ext){
  // very permissive parser: extract group-title, tvg-logo, tvg-name/tvg-id, and display name after comma
  const obj = {name:'',logo:'',group:'',type:'',mpdKid:'',mpdKey:''};
  // group-title
  const g = ext.match(/group-title\s*=\s*"(.*?)"/i);
  if(g) obj.group = g[1];
  const logo = ext.match(/tvg-logo\s*=\s*"(.*?)"/i);
  if(logo) obj.logo = logo[1];
  const tvgName = ext.match(/tvg-name\s*=\s*"(.*?)"/i);
  if(tvgName) obj.name = tvgName[1];
  const tvgID = ext.match(/tvg-id\s*=\s*"(.*?)"/i);
  if(tvgID && !obj.name) obj.name = tvgID[1];
  // after last comma is display name
  const afterComma = ext.split(',').pop().trim();
  if(afterComma && afterComma !== ext) obj.name = obj.name || afterComma;

  // check KODIPROP license_key if present
  const k = ext.match(/license_key\s*=\s*([\w:]+)/i);
  if(k){
    const pair = k[1].split(':');
    if(pair.length===2){ obj.mpdKid = pair[0]; obj.mpdKey = pair[1]; obj.type='dash'; }
  }

  return obj;
}

/* ======= UI rendering ======= */
const groupsList = document.getElementById('groupsList');
const channelsList = document.getElementById('channelsList');
const nowPlaying = document.getElementById('nowPlaying');
const video = document.getElementById('video');

let currentGroup = null;
let hlsPlayer = null;
let dashPlayer = null;

function rebuildGroups(){
  groupsList.innerHTML = '';
  const arr = Array.from(groups).sort();
  // Add "All"
  const allBtn = document.createElement('button');
  allBtn.className = 'group-btn' + (currentGroup===null ? ' active':'');
  allBtn.textContent = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
  allBtn.onclick = ()=>{ currentGroup = null; rebuildGroups(); renderChannels(); };
  groupsList.appendChild(allBtn);

  arr.forEach(g=>{
    const btn = document.createElement('button');
    btn.className = 'group-btn' + (currentGroup===g ? ' active':'');
    btn.textContent = g || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î)';
    btn.onclick = ()=>{ currentGroup = g; rebuildGroups(); renderChannels(); };
    groupsList.appendChild(btn);
  });
}

function renderChannels(filterText=''){
  channelsList.innerHTML = '';
  const filtered = channels.filter(ch=>{
    if(currentGroup && ch.group !== currentGroup) return false;
    if(filterText && !(ch.name||'').toLowerCase().includes(filterText.toLowerCase())) return false;
    return true;
  });

  if(filtered.length===0){
    channelsList.innerHTML = `<div class="small" style="grid-column:1/-1;color:var(--muted)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  filtered.forEach(ch=>{
    const card = document.createElement('div');
    card.className = 'channel-card';
    card.onclick = ()=>playChannel(ch);
    const img = document.createElement('img');
    img.src = ch.logo || 'https://via.placeholder.com/320x180?text=No+Logo';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<div style="font-weight:600">${escapeHtml(ch.name||'Unnamed')}</div><div class="small">${escapeHtml(ch.url)}</div>`;
    card.appendChild(img); card.appendChild(meta);
    channelsList.appendChild(card);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

/* ======= Player logic ======= */
function stopPlayers(){
  if(hlsPlayer){ try{ hlsPlayer.destroy(); }catch(e){} hlsPlayer=null; }
  if(dashPlayer){ try{ dashPlayer.reset(); }catch(e){} dashPlayer=null; }
  try{ video.pause(); video.removeAttribute('src'); video.load(); }catch(e){}
}

function playChannel(ch){
  stopPlayers();
  nowPlaying.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô: ${ch.name}`;
  const url = ch.url;
  const type = ch.type || detectType(url);
  if(type==='hls'){
    // use hls.js if supported, otherwise native
    if(Hls && Hls.isSupported()){
      hlsPlayer = new Hls();
      hlsPlayer.loadSource(url);
      hlsPlayer.attachMedia(video);
      hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() { video.play().catch(()=>{}); });
    } else {
      video.src = url;
      video.play().catch(()=>{});
    }
  } else if(type==='dash'){
    // dash.js
    dashPlayer = dashjs.MediaPlayer().create();
    // if mpd kid/key provided, set protectionData for ClearKey
    if(ch.mpdKid && ch.mpdKey){
      const kid = normalizeToBase64(ch.mpdKid);
      const key = normalizeToBase64(ch.mpdKey);
      const clearkeys = {};
      clearkeys[kid] = key;
      dashPlayer.setProtectionData({
        "org.w3.clearkey": { clearkeys }
      });
    }
    dashPlayer.initialize(video, url, true);
  } else {
    // progressive mp4/ts or unknown => set src directly
    video.src = url;
    video.play().catch(()=>{});
  }
}

/* detect by extension */
function detectType(url){
  const u = url.split('?')[0].toLowerCase();
  if(u.endsWith('.m3u8')) return 'hls';
  if(u.endsWith('.mpd')) return 'dash';
  if(u.endsWith('.mp4') || u.endsWith('.ts') || u.match(/\.(mov|mkv)$/)) return 'progressive';
  // if contains m3u8 query
  if(u.includes('m3u8')) return 'hls';
  return 'progressive';
}

/* Normalize hex -> base64 (attempt) or return as-is (if already base64) */
function normalizeToBase64(s){
  // detect hex (only 0-9a-f)
  if(/^[0-9a-fA-F]+$/.test(s) && s.length % 2 === 0){
    // convert hex to bytes then to base64
    const bytes = s.match(/.{1,2}/g).map(h=>parseInt(h,16));
    let binary = '';
    bytes.forEach(b=> binary += String.fromCharCode(b));
    return btoa(binary);
  }
  // if seems already base64 allow (remove padding issues)
  return s;
}

/* ======= Add / Import / Export ======= */
document.getElementById('addBtn').addEventListener('click',()=>{
  const name = document.getElementById('chName').value.trim();
  const url = document.getElementById('chUrl').value.trim();
  if(!name || !url) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ URL');
  const logo = document.getElementById('chLogo').value.trim();
  const group = document.getElementById('chGroup').value.trim() || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î)';
  const type = document.getElementById('chType').value || '';
  const mpdKid = document.getElementById('mpdKid').value.trim();
  const mpdKey = document.getElementById('mpdKey').value.trim();

  channels.push({name,url,logo,group,type,mpdKid,mpdKey});
  groups.add(group);
  rebuildGroups();
  renderChannels(document.getElementById('searchInput').value);
  document.getElementById('addForm').reset();
});

document.getElementById('clearForm').addEventListener('click',()=>{
  document.getElementById('addForm').reset();
});

document.getElementById('searchInput').addEventListener('input', (e)=>{
  renderChannels(e.target.value);
});

/* Import M3U button (open file input) */
document.getElementById('importBtn').addEventListener('click', ()=>{
  document.getElementById('m3uFile').click();
});

/* File input handling */
document.getElementById('m3uFile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const txt = reader.result;
    const parsed = parseM3U(txt);
    parsed.fo
